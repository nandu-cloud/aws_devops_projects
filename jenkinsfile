pipeline 
{
    agent any
    stages
    {
        stage("Git Clone") 
        {
            steps {
                git 'https://github.com/nandu-cloud/aws_devops_projects.git'
                  }
         }
            stage("Maven Builds")
            {
            steps {
                sh "mvn validate"            
                sh "mvn clean package"
                sh "mvn compile"
                sh "mvn test"
                sh "mvn install"
                sh "mv target/*.war target/myweb.war"
                  }
           }
            stage ("deploy-dev")
          {
            steps{
             sshagent(['jenkins_key']) 
             {
           sh """
           scp -o StrictHostKeyChecking=no target/myweb.war ec2-user@172.31.15.244:/opt/tomcat/webapps/
           
           ssh ec2-user@172.31.15.244 /opt/tomcat/bin/shutdown.sh

           ssh ec2-user@172.31.15.244 /opt/tomcat/bin/startup.sh
      
              """       
            }
            
              }
         }
         stage('Upload Artifacts to Artifactory') {
          steps {
            rtUpload (
                serverId: 'Artifactory',
                spec: '''{
                  "files": [
                    {
                      "pattern": "target/myweb.war",
                      "target": "Artifactory/"
                    }
                  ]
            }'''
            )
                      
            }
          }
    }
}     

